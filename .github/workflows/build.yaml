name: Build - Publish Image

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  build_publish:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-southeast-1
      ECR_REGISTRY: 927041702050.dkr.ecr.ap-southeast-1.amazonaws.com
      ECR_REPOSITORY: nus/project/authservice
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup AWS Credentials Using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate Docker with Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Determine Latest Version and Increment
        id: version
        run: |
          tags=$(aws ecr list-images --repository-name ${{ env.ECR_REPOSITORY }} --query 'imageIds[*].imageTag' --output text | tr '\t' '\n')
          latest_version=$(echo "$tags" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            latest_version="v1.0.0"
          fi

          IFS='.' read -r major minor patch <<< "${latest_version#v}"
          commit_message=$(git log -1 --pretty=%B)
          merge_source=$(echo "$commit_message" | sed -n 's/.*from .*\/\([^ ]*\).*/\1/p')

          bump="patch"
          if echo "$commit_message" | grep -Eiq 'breaking|BREAKING CHANGE' || echo "$merge_source" | grep -Eiq '^(breaking|major)/'; then
            bump="major"
          elif echo "$commit_message" | grep -Eiq 'feat' || echo "$merge_source" | grep -Eiq '^(feat|minor)/'; then
            bump="minor"
          elif echo "$merge_source" | grep -Eiq '^(fix|patch)/'; then
            bump="patch"
          fi

          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            *)
              patch=$((patch + 1))
              ;;
          esac

          new_version="v$major.$minor.$patch"
          echo "New Version: $new_version"
          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Build Docker Image
        run: docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }} .

      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          format: sarif
          output: trivy-image.sarif

      - name: Upload Trivy Image Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image.sarif

      - name: Push Docker Image to Amazon ECR
        run: docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}

      - name: Export Image Metadata
        run: |
          printf '{"image":"%s","version":"%s"}' \
            "${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}" \
            "${{ steps.version.outputs.version }}" > image.json

      - name: Upload Image Metadata
        uses: actions/upload-artifact@v4
        with:
          name: image-metadata
          path: image.json
