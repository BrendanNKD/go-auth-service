# ──────────────────────────────────────────────────────────────────────────────
#  CI – Lint ▸ Test ▸ Security ▸ Build & Image Scan
# ──────────────────────────────────────────────────────────────────────────────
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches:
      - main
      - feat/**
      - fix/**
      - minor/**
      - breaking/**
      - major/**
      - patch/**

permissions:
  contents: read
  security-events: write

# Cancel redundant runs on the same branch / PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# ──────────────────────────────────────────────────────────────────────────────
jobs:

  # ── 1. Lint ─────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    env:
      CGO_ENABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install C toolchain
        run: sudo apt-get update && sudo apt-get install -y gcc

      - name: Download Dependencies
        run: go mod download

      - name: Go Vet
        run: go vet ./...

  # ── 2. Unit Tests ──────────────────────────────────────────────────────────
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    env:
      CGO_ENABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install C toolchain
        run: sudo apt-get update && sudo apt-get install -y gcc

      - name: Download Dependencies
        run: go mod download

      - name: Run Tests
        run: |
          go test ./... -race -count=1 \
            -coverprofile=coverage.out \
            -covermode=atomic \
            -json > test-report.json 2>&1 || true
          # Verify tests actually passed (go test -json exits 0 even on failure when piped)
          go test ./... -race -count=1 -coverprofile=/dev/null

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-report.json
            coverage.out

  # ── 3. Secret Scan (Gitleaks) ──────────────────────────────────────────────
  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── 4. Dependency & Config Scan (Trivy + Snyk) ─────────────────────────────
  sca-scan:
    name: SCA & Misconfig Scan
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Trivy filesystem scan – table output for log readability
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: "0"
          format: table

      # Trivy filesystem scan – SARIF for GitHub Security tab
      - name: Trivy Filesystem SARIF Report
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: "0"
          format: sarif
          output: trivy-fs.sarif

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-filesystem

      # Snyk – conditional on token availability
      - name: Snyk Vulnerability Scan
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/golang@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif

      - name: Upload Snyk SARIF to GitHub Security
        if: env.SNYK_TOKEN != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk.sarif
          category: snyk

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-fs.sarif
            snyk.sarif
          if-no-files-found: ignore

  # ── 5. Build Docker Image & Image Scan ─────────────────────────────────────
  build:
    name: Build & Image Scan
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: authservice:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Trivy image scan – table output for logs
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: authservice:ci
          severity: CRITICAL,HIGH
          scanners: vuln
          ignore-unfixed: true
          exit-code: "0"
          format: table

      # Trivy image scan – SARIF for GitHub Security tab
      - name: Trivy Image SARIF Report
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: authservice:ci
          severity: CRITICAL,HIGH
          scanners: vuln
          ignore-unfixed: true
          exit-code: "0"
          format: sarif
          output: trivy-image.sarif

      - name: Upload Trivy Image SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-image.sarif
          category: trivy-image
